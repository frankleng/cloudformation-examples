{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"AWS Self Terminating example",
   "Parameters":{
      "KeyName":{
         "Description":"Name of an existing EC2 KeyPair to enable SSH access to the instances",
         "Type":"String",
         "MinLength":"1",
         "MaxLength":"255",
         "AllowedPattern":"[\\x20-\\x7E]*",
         "ConstraintDescription":"can contain only ASCII characters."
      },
      "InstanceType":{
         "Description":"WebServer EC2 instance type",
         "Type":"String",
         "Default":"t1.micro",
         "AllowedValues":[
            "t1.micro",
            "m1.small",
            "m1.medium",
            "m1.large",
            "m1.xlarge",
            "m2.xlarge",
            "m2.2xlarge",
            "m2.4xlarge",
            "m3.xlarge",
            "m3.2xlarge",
            "c1.medium",
            "c1.xlarge",
            "cc1.4xlarge",
            "cc2.8xlarge",
            "cg1.4xlarge"
         ],
         "ConstraintDescription":"must be a valid EC2 instance type."
      },
      "SSHLocation":{
         "Description":" The IP address range that can be used to SSH to the EC2 instances",
         "Type":"String",
         "MinLength":"9",
         "MaxLength":"18",
         "Default":"0.0.0.0/0",
         "AllowedPattern":"(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
         "ConstraintDescription":"must be a valid IP CIDR range of the form x.x.x.x/x."
      },
      "ScaleUpTme":{
         "Description":"Recurring cron style scale up time",
         "Type":"String",
         "Default":"0 0 * * *"
      },
      "ScaleDownTme":{
         "Description":"Recurring cron style scale down time (dead switch in case cron overruns)",
         "Type":"String",
         "Default":"0 12 * * *"
      }
   },
   "Mappings":{
      "AWSInstanceType2Arch":{
         "t1.micro":{
            "Arch":"32"
         },
         "m1.small":{
            "Arch":"32"
         },
         "m1.large":{
            "Arch":"64"
         },
         "m1.xlarge":{
            "Arch":"64"
         },
         "m2.xlarge":{
            "Arch":"64"
         },
         "m2.2xlarge":{
            "Arch":"64"
         },
         "m2.4xlarge":{
            "Arch":"64"
         },
         "m3.xlarge":{
            "Arch":"64"
         },
         "m3.2xlarge":{
            "Arch":"64"
         },
         "c1.medium":{
            "Arch":"32"
         },
         "c1.xlarge":{
            "Arch":"64"
         },
         "cc1.4xlarge":{
            "Arch":"64"
         }
      },
      "AWSRegionArch2AMI":{
         "us-east-1":{
            "32":"ami-7f418316",
            "64":"ami-7341831a"
         },
         "us-west-1":{
            "32":"ami-951945d0",
            "64":"ami-971945d2"
         },
         "us-west-2":{
            "32":"ami-16fd7026",
            "64":"ami-10fd7020"
         },
         "eu-west-1":{
            "32":"ami-24506250",
            "64":"ami-20506254"
         },
         "sa-east-1":{
            "32":"ami-3e3be423",
            "64":"ami-3c3be421"
         },
         "ap-southeast-1":{
            "32":"ami-74dda626",
            "64":"ami-7edda62c"
         },
         "ap-southeast-2":{
            "32":"ami-b3990e89",
            "64":"ami-bd990e87"
         },
         "ap-northeast-1":{
            "32":"ami-dcfa4edd",
            "64":"ami-e8fa4ee9"
         }
      }
   },
   "Resources":{
      "SelfTerminatingLaunchConfiguration":{
         "Type":"AWS::AutoScaling::LaunchConfiguration",
         "Metadata":{
            "AWS::CloudFormation::Init":{
               "config":{
                  "packages":{
                     "yum":{
                        "aws-cli":[

                        ]
                     }
                  }
               }
            }
         },
         "Properties":{
            "ImageId":{
               "Fn::FindInMap":[
                  "AWSRegionArch2AMI",
                  {
                     "Ref":"AWS::Region"
                  },
                  {
                     "Fn::FindInMap":[
                        "AWSInstanceType2Arch",
                        {
                           "Ref":"InstanceType"
                        },
                        "Arch"
                     ]
                  }
               ]
            },
            "InstanceType":{
               "Ref":"InstanceType"
            },
            "SecurityGroups":[
               {
                  "Ref":"SelfTerminatingSecurityGroup"
               }
            ],
            "KeyName":{
               "Ref":"KeyName"
            },
            "IamInstanceProfile":{
               "Ref":"SelfTerminatingInstanceProfile"
            },
            "UserData":{
               "Fn::Base64":{
                  "Fn::Join":[
                     "",
                     [
                        "#!/bin/bash\n",
                        "yum update -y aws-cfn-bootstrap\n",
                        "/opt/aws/bin/cfn-init -s ",
                        {
                           "Ref":"AWS::StackId"
                        },
                        " -r SelfTerminatingLaunchConfiguration",
                        " --region ",
                        {
                           "Ref":"AWS::Region"
                        },
                        "\n",
                        "echo 'Do something useful'\n",
                        "instance_id=`curl http://169.254.169.254/latest/meta-data/instance-id`\n",
                        "autoscale_group=`aws ec2 describe-tags --filters \"Name=resource-id,Values=$instance_id\"",
                        " --region ",
                        {
                           "Ref":"AWS::Region"
                        },
                        " \"Name=key,Values=aws:autoscaling:groupName\"",
                        " | sed -ne 's\/[ ]*\"Value\":\\s\"\\(.*\\)\",\/\\1\/p'`\n",
                        "aws autoscaling update-auto-scaling-group --auto-scaling-group-name $autoscale_group",
                        " --region ",
                        {
                           "Ref":"AWS::Region"
                        },
                        " --min-size 0 --max-size 0 --desired-capacity 0\n"
                     ]
                  ]
               }
            }
         }
      },
      "SelfTerminatingAutoScalingGroup":{
         "Type":"AWS::AutoScaling::AutoScalingGroup",
         "Properties":{
            "AvailabilityZones":{
               "Fn::GetAZs":{
                  "Ref":"AWS::Region"
               }
            },
            "LaunchConfigurationName":{
               "Ref":"SelfTerminatingLaunchConfiguration"
            },
            "Tags":[
               {
                  "Key":"Name",
                  "Value":"SelfTerminating",
                  "PropagateAtLaunch":"true"
               }
            ],
            "MinSize":"0",
            "MaxSize":"0",
            "DesiredCapacity":"0"
         }
      },
      "SelfTerminatingScaleUpScheduledAction":{
         "Type":"AWS::AutoScaling::ScheduledAction",
         "Properties":{
            "AutoScalingGroupName":{
               "Ref":"SelfTerminatingAutoScalingGroup"
            },
            "MaxSize":"1",
            "MinSize":"1",
            "DesiredCapacity":"1",
            "Recurrence":{
               "Ref":"ScaleUpTme"
            }
         }
      },
      "SelfTerminatingScaleDownScheduledAction":{
         "Type":"AWS::AutoScaling::ScheduledAction",
         "Properties":{
            "AutoScalingGroupName":{
               "Ref":"SelfTerminatingAutoScalingGroup"
            },
            "MaxSize":"0",
            "MinSize":"0",
            "DesiredCapacity":"0",
            "Recurrence":{
               "Ref":"ScaleDownTme"
            }
         }
      },
      "SelfTerminatingRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "Path":"/",
            "Policies":[
               {
                  "PolicyName":"SelfTerminatingRole",
                  "PolicyDocument":{
                     "Version":"2012-10-17",
                     "Statement":[
                        {
                           "Action":[
                              "ec2:Describe*",
                              "cloudformation:DescribeStackResource"
                           ],
                           "Resource":[
                              "*"
                           ],
                           "Effect":"Allow"
                        },
                        {
                           "Effect":"Allow",
                           "Action":"autoscaling:UpdateAutoScalingGroup",
                           "Resource":[
                              "*"
                           ]
                        }
                     ]
                  }
               }
            ],
            "AssumeRolePolicyDocument":{
               "Statement":[
                  {
                     "Action":[
                        "sts:AssumeRole"
                     ],
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "ec2.amazonaws.com"
                        ]
                     }
                  }
               ]
            }
         }
      },
      "SelfTerminatingInstanceProfile":{
         "Type":"AWS::IAM::InstanceProfile",
         "Properties":{
            "Path":"/",
            "Roles":[
               {
                  "Ref":"SelfTerminatingRole"
               }
            ]
         }
      },
      "SelfTerminatingSecurityGroup":{
         "Type":"AWS::EC2::SecurityGroup",
         "Properties":{
            "GroupDescription":"Enable SSH access from specific IPs only",
            "SecurityGroupIngress":[
               {
                  "IpProtocol":"tcp",
                  "FromPort":"22",
                  "ToPort":"22",
                  "CidrIp":{
                     "Ref":"SSHLocation"
                  }
               }
            ]
         }
      }
   }
}
